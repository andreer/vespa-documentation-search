schema paragraph {

    field language type string {
        indexing: "en" | set_language
    }
    
    field gram_title type string {
        indexing: input title | index
        match {
            gram
            gram-size: 3
        }
    }

    field gram_content type string {
        indexing: input content | index
        match {
            gram
            gram-size: 3
        }
    }

    document paragraph {

        field path type string {
            indexing: summary | index
            index: enable-bm25
            stemming: best
        }
        
         field base_uri type string {
            indexing: summary
        }

        field doc_id type string {
            indexing: summary | attribute
        }

        field title type string {
            indexing: summary | index
            index: enable-bm25
            stemming: best
        }

        field content type string {
            indexing: summary | index
            index: enable-bm25
            stemming: best
        }
        
        field questions type array<string> {
            indexing: summary | index | attribute # Attribute for grouping
            index: enable-bm25
            stemming: best
        }
        
        field content_tokens type int {
            indexing: summary
        }

        # e.g. open, cloud
        field namespace type string {
            indexing: summary | attribute
        }

        field last_updated type int {
            indexing: summary | attribute
        }
    }

    field questions_exact type array<string> {
        indexing: input questions | index
        match:word
    }

    field embedding type tensor<float>(x[384]) {
        indexing: (input title || "") . " " . (input content || "") | embed | attribute
        attribute {
            distance-metric: angular
        }
    }

    document-summary short-summary {
        from-disk
        summary title type string {}
        summary content type string {}
        summary path type string {}
        summary doc_id type string {}
    }

    fieldset default {
        fields: title, content, path, questions 
    }

    fieldset grams {
        fields: gram_title, gram_content
    }

    rank-profile default inherits default {
        inputs {
            query(embedding) tensor<float>(x[384])
        }
    }

    rank-profile semantic inherits default {
        inputs {
            query(q) tensor<float>(x[384])
        }
        first-phase {
            expression: cos(distance(field,embedding))
        }
    }

    rank-profile hybrid inherits semantic {
        inputs {
            query(q) tensor<float>(x[384])
            query(sw) double: 0.2
            query(ew) double: 0.2
        }
        function semantic() {
            expression: cos(distance(field, embedding))
        }
        function keywords() {
            expression: (nativeRank(title) + nativeRank(content) + 0.5*nativeRank(path) + query(ew)*elementCompleteness(questions).completeness)/4 + elementCompleteness(questions_exact).completeness
        }
        first-phase {
            expression: query(sw)*semantic + (1 - query(sw))*keywords
        }
        match-features: keywords semantic nativeRank(title) nativeRank(content) nativeRank(path) elementCompleteness(questions).completeness elementCompleteness(questions_exact).completeness
    }

    rank-profile documentation inherits default {
        inputs {
            query(titleWeight) double: 2.0
            query(contentWeight) double: 2.0
            query(pathWeight) double: 1.0
        }
        first-phase {
            expression {
                query(titleWeight) * bm25(title)
                + query(contentWeight) * bm25(content)
                + query(pathWeight) * bm25(path)
            }
        }
        match-features {
            query(titleWeight)
            query(contentWeight)
            query(pathWeight)
            bm25(title)
            nativeRank(title)
            bm25(content)
            bm25(path)
        }
    }
}
